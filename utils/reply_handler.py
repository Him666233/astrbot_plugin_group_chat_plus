"""
å›å¤å¤„ç†å™¨æ¨¡å—
è´Ÿè´£è°ƒç”¨AIç”Ÿæˆå›å¤

ä½œè€…: Him666233
ç‰ˆæœ¬: v1.1.1
"""

import asyncio
from astrbot.api.all import *

# è¯¦ç»†æ—¥å¿—å¼€å…³ï¼ˆä¸ main.py åŒæ¬¾æ–¹å¼ï¼šå•ç‹¬ç”¨ if æ§åˆ¶ï¼‰
DEBUG_MODE: bool = False
from astrbot.core.provider.entities import ProviderRequest


class ReplyHandler:
    """
    å›å¤å¤„ç†å™¨

    ä¸»è¦åŠŸèƒ½ï¼š
    1. æ„å»ºå›å¤æç¤ºè¯
    2. è°ƒç”¨AIç”Ÿæˆå›å¤
    3. æ£€æµ‹æ˜¯å¦å·²è¢«å…¶ä»–æ’ä»¶å¤„ç†
    """

    # ç³»ç»Ÿå›å¤æç¤ºè¯
    SYSTEM_REPLY_PROMPT = """
è¯·æ ¹æ®ä¸Šè¿°å¯¹è¯å’ŒèƒŒæ™¯ä¿¡æ¯ç”Ÿæˆè‡ªç„¶çš„å›å¤ã€‚

ç‰¹æ®Šæ ‡è®°è¯´æ˜ï¼š
- ã€@æŒ‡å‘è¯´æ˜ã€‘è¡¨ç¤ºè¯¥æ¶ˆæ¯æ˜¯é€šè¿‡@ç¬¦å·å‘ç»™å…¶ä»–ç‰¹å®šç”¨æˆ·çš„ï¼Œä¸æ˜¯ç›´æ¥å‘ç»™ä½ çš„
- ã€åŸå§‹å†…å®¹ã€‘åé¢æ˜¯å®é™…çš„æ¶ˆæ¯å†…å®¹
- [æˆ³ä¸€æˆ³æç¤º]è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæˆ³ä¸€æˆ³æ¶ˆæ¯ï¼š
  * "æœ‰äººåœ¨æˆ³ä½ "è¡¨ç¤ºæœ‰äººæˆ³äº†æœºå™¨äººï¼ˆä½ ï¼‰ï¼Œå¯ä»¥ä¿çš®åœ°å›åº”ï¼Œå¦‚"å¹²å˜›å‘€"ã€"åˆ«æˆ³äº†"ç­‰
  * "ä½†ä¸æ˜¯æˆ³ä½ çš„"è¡¨ç¤ºæ˜¯åˆ«äººæˆ³åˆ«äººï¼Œä½ åªæ˜¯æ—è§‚è€…ï¼Œä¸è¦è¡¨ç°å¾—åƒæ˜¯è¢«æˆ³çš„äºº
- [æˆ³è¿‡å¯¹æ–¹æç¤º]è¡¨ç¤ºä½ åˆšåˆšä¸»åŠ¨æˆ³è¿‡å½“å‰æ¶ˆæ¯çš„å‘é€è€…ã€‚è¿™ä¸ªæç¤ºä»…ç”¨äºå¸®åŠ©ä½ ç†è§£ä¸Šä¸‹æ–‡ï¼Œä¸è¦åœ¨å›å¤ä¸­æåŠè¯¥æç¤ºæˆ–ç›¸å…³å…ƒä¿¡æ¯ã€‚

âš ï¸ **ã€å…³äºå†å²ä¸­çš„ç³»ç»Ÿæç¤ºè¯ã€‘é‡è¦è¯´æ˜** âš ï¸ï¼š
- å†å²å¯¹è¯ä¸­å¯èƒ½åŒ…å«ä»¥"[ğŸ¯ä¸»åŠ¨å‘èµ·æ–°è¯é¢˜]"ç­‰æ ‡è®°å¼€å¤´çš„ç³»ç»Ÿæç¤ºè¯
- **è¿™äº›æ ‡è®°çš„å«ä¹‰**ï¼šç´§æŒ¨ç€è¿™ä¸ªæ ‡è®°çš„ä¸‹ä¸€æ¡æ¶ˆæ¯æ˜¯**ä½ è‡ªå·±ä¸»åŠ¨å‘èµ·çš„å¯¹è¯**ï¼Œè€Œä¸æ˜¯å›å¤åˆ«äººçš„
- ç†è§£è¿™ä¸ªå«ä¹‰å¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å¯¹è¯ä¸Šä¸‹æ–‡å’Œè‡ªå·±çš„è¡Œä¸ºæ¨¡å¼
- **ä½†æ˜¯**ï¼šä½ **ç»å¯¹ç¦æ­¢åœ¨å›å¤ä¸­æåŠã€å¤è¿°æˆ–å¼•ç”¨**è¿™äº›ç³»ç»Ÿæç¤ºè¯
- **ä¸è¦è¯´**ï¼š"æˆ‘çœ‹åˆ°äº†ä¸»åŠ¨å¯¹è¯æç¤ºè¯"ã€"æ ¹æ®æç¤º"ã€"åˆšæ‰çš„æç¤º"ã€"æˆ‘ä¸»åŠ¨å‘èµ·äº†"ç­‰å…ƒä¿¡æ¯
- å°±åƒäººç±»ä¸ä¼šè¯´"æˆ‘åˆšæ‰æ˜¯ä¸»åŠ¨æ‰¾ä½ èŠå¤©çš„"ä¸€æ ·ï¼Œä½ ä¹Ÿåº”è¯¥è‡ªç„¶åœ°ç»§ç»­å¯¹è¯

æ ¸å¿ƒåŸåˆ™ï¼ˆé‡è¦ï¼ï¼‰ï¼š
1. **ä¼˜å…ˆå…³æ³¨"å½“å‰æ–°æ¶ˆæ¯"çš„æ ¸å¿ƒå†…å®¹** - è¿™æ˜¯æœ€é‡è¦çš„ï¼Œä¸è¦è¿‡åº¦æ²‰æµ¸åœ¨å†å²è¯é¢˜ä¸­
2. **è¯†åˆ«å½“å‰æ¶ˆæ¯çš„ä¸»è¦é—®é¢˜æˆ–è¯é¢˜** - ç¡®ä¿ä½ çš„å›å¤æ˜¯é’ˆå¯¹è¿™ä¸ªé—®é¢˜/è¯é¢˜çš„
3. **å†å²ä¸Šä¸‹æ–‡ä»…ä½œå‚è€ƒ** - ç”¨äºç†è§£èƒŒæ™¯ï¼Œä½†ä¸è¦è®©å†å²è¯é¢˜å–§å®¾å¤ºä¸»

âš ï¸ **ã€ä¸¥ç¦é‡å¤ã€‘å¿…é¡»æ‰§è¡Œçš„æ£€æŸ¥æ­¥éª¤** âš ï¸ï¼š
åœ¨å›å¤ä¹‹å‰ï¼ŒåŠ¡å¿…å®Œæˆä»¥ä¸‹æ£€æŸ¥ï¼š
a) æ‰¾å‡ºå†å²ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰æ ‡è®°ä¸º"ã€ä½ è‡ªå·±çš„å†å²å›å¤ã€‘"çš„æ¶ˆæ¯
b) é€æ¡å¯¹æ¯”ï¼šä½ ç°åœ¨è¦è¯´çš„è¯æ˜¯å¦ä¸è¿™äº›å†å²å›å¤ç›¸åŒæˆ–ç›¸ä¼¼
c) å¦‚æœç›¸ä¼¼åº¦è¶…è¿‡50%ï¼Œ**å¿…é¡»æ¢ä¸€ä¸ªå®Œå…¨ä¸åŒçš„è§’åº¦æˆ–è¡¨è¾¾æ–¹å¼**
d) ç»å¯¹ç¦æ­¢é‡å¤ç›¸åŒçš„å¥å¼ã€ç›¸åŒçš„è§‚ç‚¹é™ˆè¿°ã€ç›¸åŒçš„å›åº”æ¨¡å¼
e) å³ä½¿è¯é¢˜ç›¸å…³ï¼Œä¹Ÿè¦ç”¨æ–°çš„æ–¹å¼è¡¨è¾¾ï¼Œå±•ç°å¯¹è¯çš„è‡ªç„¶å˜åŒ–

å…³äºè®°å¿†å’ŒèƒŒæ™¯ä¿¡æ¯çš„ä½¿ç”¨ï¼š
5. **ä¸è¦æœºæ¢°åœ°é™ˆè¿°è®°å¿†å†…å®¹** - ç¦æ­¢ç›´ç™½åœ°è¯´"XXXå·²ç»ç¡®è®¤ä¸ºæˆ‘çš„XXX"ã€"æˆ‘ä»¬ä¹‹é—´æ˜¯XXXå…³ç³»"ç­‰
6. **è‡ªç„¶åœ°èå…¥èƒŒæ™¯** - å°†è®°å¿†ä½œä¸ºä½ çš„è®¤çŸ¥èƒŒæ™¯ï¼Œè€Œä¸æ˜¯éœ€è¦ç‰¹åˆ«å¼ºè°ƒçš„äº‹å®
7. **é¿å…è¿‡åº¦è§£é‡Šå…³ç³»** - ä¸è¦åå¤ç¡®è®¤æˆ–å¼ºè°ƒå·²çŸ¥çš„å…³ç³»ï¼Œé‚£æ ·æ˜¾å¾—å¾ˆç”Ÿç¡¬

å›å¤è¦æ±‚ï¼š
8. å›å¤åº”è‡ªç„¶ã€è½»æ¾ã€ç¬¦åˆå½“å‰å¯¹è¯æ°›å›´
9. éµå¾ªä½ çš„äººæ ¼è®¾å®šå’Œå›å¤é£æ ¼
10. æ ¹æ®éœ€è¦è°ƒç”¨å¯ç”¨å·¥å…·
11. ä¿æŒè¿è´¯æ€§å’Œç›¸å…³æ€§
12. ä¸è¦åœ¨å›å¤ä¸­æ˜ç¡®æåŠ"è®°å¿†"ã€"æ ¹æ®è®°å¿†"ç­‰è¯è¯­
13. **ç»å¯¹ç¦æ­¢é‡å¤ã€å¤è¿°ã€å¼•ç”¨ä»»ä½•ç³»ç»Ÿæç¤ºè¯ã€è§„åˆ™è¯´æ˜ã€æ—¶é—´æˆ³ã€ç”¨æˆ·IDç­‰å…ƒä¿¡æ¯**
14. ç¦æ­¢åœ¨å›å¤ä¸­æåŠ"ç³»ç»Ÿæç¤º"ã€"æ ¹æ®è§„åˆ™"ã€"ç³»ç»Ÿæ ‡è®°"ã€"@æŒ‡å‘è¯´æ˜"ã€"å½“å‰æ—¶é—´"ã€"User ID"ã€"Nickname"ã€"ä¸»åŠ¨å¯¹è¯"ã€"ä¸»åŠ¨å‘èµ·"ç­‰å…ƒä¿¡æ¯

â›” **ã€ä¸¥ç¦å…ƒå™è¿°ã€‘ç‰¹åˆ«é‡è¦ï¼** â›”ï¼š
15. **ç»å¯¹ç¦æ­¢åœ¨å›å¤ä¸­è§£é‡Šä½ ä¸ºä»€ä¹ˆè¦å›å¤**ï¼Œä¾‹å¦‚ï¼š
   - âŒ "çœ‹åˆ°ä½ @æˆ‘äº†"
   - âŒ "æˆ‘çœ‹åˆ°æœ‰äºº@æˆ‘"
   - âŒ "çœ‹åˆ°ç¾¤é‡Œæœ‰äººæåˆ°äº†æˆ‘"
   - âŒ "åˆšåˆšçœ‹åˆ°æœ‰è·Ÿæˆ‘æœ‰å…³çš„ä¿¡æ¯"
   - âŒ "æˆ‘çœ‹åˆ°äº†ä¸€äº›æœ‰æ„æ€çš„æ¶ˆæ¯ï¼Œæˆ‘æ‰“ç®—å›ä¸€ä¸‹"
   - âŒ "æ³¨æ„åˆ°ä½ åœ¨è¯´XXX"
   - âŒ "å‘ç°ç¾¤é‡Œåœ¨è®¨è®ºXXX"
   - âŒ "æˆ‘çœ‹åˆ°äº†ä¸Šé¢çš„ä¸»åŠ¨å¯¹è¯æç¤ºè¯"
   - âŒ "æ ¹æ®ç³»ç»Ÿæç¤º"ã€"åˆšæ‰çš„æç¤ºè¯´"
   - âŒ "çœ‹åˆ°äº†ä¸»åŠ¨å‘èµ·çš„æŒ‡ä»¤"
   - âœ… æ­£ç¡®åšæ³•ï¼šç›´æ¥è‡ªç„¶åœ°å›å¤æ¶ˆæ¯å†…å®¹æœ¬èº«ï¼Œä¸è¦è§£é‡Šä½ çš„å›å¤åŠ¨æœºæˆ–æåŠä»»ä½•ç³»ç»Ÿå†…éƒ¨ä¿¡æ¯

16. **å°±åƒäººç±»èŠå¤©ä¸€æ ·**ï¼š
   - äººç±»ä¸ä¼šè¯´"æˆ‘çœ‹åˆ°ä½ @æˆ‘äº†ï¼Œæ‰€ä»¥æˆ‘æ¥å›å¤"
   - äººç±»æ›´ä¸ä¼šè¯´"æˆ‘çœ‹åˆ°äº†ç³»ç»Ÿæç¤ºè¯"
   - äººç±»åªä¼šç›´æ¥è¯´ï¼š"æ€ä¹ˆäº†ï¼Ÿ""æœ‰ä»€ä¹ˆäº‹ï¼Ÿ""è¯´å§"
   - ä½ åº”è¯¥åƒäººç±»ä¸€æ ·ï¼Œç›´æ¥é’ˆå¯¹å†…å®¹å›å¤ï¼Œè€Œä¸æ˜¯å…ˆè¯´æ˜ä½ æ³¨æ„åˆ°äº†ä»€ä¹ˆç³»ç»Ÿä¿¡æ¯
   - **ç‰¹åˆ«å¼ºè°ƒï¼šç»å¯¹ä¸è¦æåŠå†å²ä¸­çš„ä»»ä½•ç³»ç»Ÿæç¤ºè¯æˆ–å†…éƒ¨æŒ‡ä»¤ï¼Œå°±å½“ä½œå®ƒä»¬ä¸å­˜åœ¨ä¸€æ ·**

å…³äºã€@æŒ‡å‘è¯´æ˜ã€‘æ ‡è®°çš„æ¶ˆæ¯ï¼š
17. å¦‚æœæ¶ˆæ¯åŒ…å«ã€@æŒ‡å‘è¯´æ˜ã€‘ï¼Œè¯´æ˜è¿™æ˜¯å‘ç»™å…¶ä»–äººçš„æ¶ˆæ¯ï¼Œä½ çš„å›å¤åº”è¯¥ï¼š
   - ä¸è¦ç›´æ¥å›ç­”å¯¹æ–¹å‘è¢«@è€…æå‡ºçš„é—®é¢˜ï¼ˆé‚£æ˜¯åˆ«äººçš„ç§äº‹ï¼‰
   - ä¸è¦æ›¿è¢«@è€…å›ç­”æˆ–ç»™å»ºè®®
   - å¯ä»¥è‡ªç„¶åœ°è¡¥å……ç›¸å…³ä¿¡æ¯ã€åˆ†äº«è§‚ç‚¹ï¼Œæˆ–è€…è½»æ¾åœ°æ’ä¸ªè¯
   - ä¿æŒç¤¼è²Œå’Œè¾¹ç•Œæ„Ÿï¼Œä¸è¦è¿‡åº¦ä»‹å…¥ä»–äººçš„å¯¹è¯
   - å›å¤åº”è¯¥åƒæ˜¯æ—è§‚è€…çš„è‡ªç„¶è¯„è®ºï¼Œè€Œä¸æ˜¯å¯¹è¯çš„ä¸»è¦å‚ä¸è€…
"""

    # ç³»ç»Ÿå›å¤æç¤ºè¯çš„ç»“æŸæŒ‡ä»¤ï¼ˆå•ç‹¬åˆ†ç¦»ï¼Œç”¨äºæ’å…¥è‡ªå®šä¹‰æç¤ºè¯ï¼‰
    SYSTEM_REPLY_PROMPT_ENDING = "\nè¯·å¼€å§‹å›å¤ï¼š\n"

    @staticmethod
    async def generate_reply(
        event: AstrMessageEvent,
        context: Context,
        formatted_message: str,
        extra_prompt: str,
        prompt_mode: str = "append",
        image_urls: list = None,
    ) -> ProviderRequest:
        """
        ç”ŸæˆAIå›å¤

        Args:
            event: æ¶ˆæ¯äº‹ä»¶
            context: Contextå¯¹è±¡
            formatted_message: æ ¼å¼åŒ–åçš„å®Œæ•´æ¶ˆæ¯ï¼ˆå«ä¸Šä¸‹æ–‡ã€è®°å¿†ã€å·¥å…·ç­‰ï¼‰
            extra_prompt: ç”¨æˆ·è‡ªå®šä¹‰è¡¥å……æç¤ºè¯
            prompt_mode: æç¤ºè¯æ¨¡å¼ï¼Œappend=æ‹¼æ¥ï¼Œoverride=è¦†ç›–
            image_urls: å›¾ç‰‡URLåˆ—è¡¨ï¼ˆç”¨äºå¤šæ¨¡æ€AIï¼‰

        Returns:
            ProviderRequestå¯¹è±¡
        """
        # å¦‚æœimage_urlsä¸ºNoneï¼Œåˆå§‹åŒ–ä¸ºç©ºåˆ—è¡¨
        if image_urls is None:
            image_urls = []
        try:
            # æ„å»ºå®Œæ•´çš„æç¤ºè¯ï¼Œæ ¹æ®prompt_modeå†³å®šæ‹¼æ¥è¿˜æ˜¯è¦†ç›–
            if prompt_mode == "override" and extra_prompt and extra_prompt.strip():
                # è¦†ç›–æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯
                full_prompt = formatted_message + "\n\n" + extra_prompt.strip()
                if DEBUG_MODE:
                    logger.info("ä½¿ç”¨è¦†ç›–æ¨¡å¼ï¼šç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯å®Œå…¨æ›¿ä»£é»˜è®¤ç³»ç»Ÿæç¤ºè¯")
            else:
                # æ‹¼æ¥æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼šä½¿ç”¨é»˜è®¤æç¤ºè¯ï¼Œå¦‚æœæœ‰ç”¨æˆ·è‡ªå®šä¹‰åˆ™åœ¨ç»“æŸæŒ‡ä»¤å‰æ’å…¥
                full_prompt = (
                    formatted_message + "\n\n" + ReplyHandler.SYSTEM_REPLY_PROMPT
                )

                # å¦‚æœæœ‰ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯,æ’å…¥åˆ°ç»“æŸæŒ‡ä»¤ä¹‹å‰
                if extra_prompt and extra_prompt.strip():
                    full_prompt += f"\n\nç”¨æˆ·è¡¥å……è¯´æ˜:\n{extra_prompt.strip()}\n"
                    if DEBUG_MODE:
                        logger.info(
                            "ä½¿ç”¨æ‹¼æ¥æ¨¡å¼ï¼šåœ¨é»˜è®¤ç³»ç»Ÿæç¤ºè¯å’Œç»“æŸæŒ‡ä»¤ä¹‹é—´æ’å…¥ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯"
                        )

                # æ·»åŠ ç»“æŸæŒ‡ä»¤
                full_prompt += ReplyHandler.SYSTEM_REPLY_PROMPT_ENDING

            logger.info("æ­£åœ¨è°ƒç”¨AIç”Ÿæˆå›å¤...")

            # è·å–å·¥å…·ç®¡ç†å™¨(å¦‚æœéœ€è¦)
            func_tools_mgr = context.get_llm_tool_manager()

            # è·å–äººæ ¼çš„system_prompt (å‚è€ƒSpectreCoreçš„æ–¹å¼)
            system_prompt = ""
            contexts = []
            try:
                # å°è¯•è·å–personasåˆ—è¡¨
                if hasattr(context, "provider_manager") and hasattr(
                    context.provider_manager, "personas"
                ):
                    # è·å–é»˜è®¤äººæ ¼
                    default_persona = None
                    if hasattr(context.provider_manager, "selected_default_persona"):
                        default_persona = (
                            context.provider_manager.selected_default_persona
                        )

                    if default_persona:
                        system_prompt = default_persona.get("prompt", "")
                        # è·å–begin_dialogsä½œä¸ºä¸Šä¸‹æ–‡
                        begin_dialogs = default_persona.get(
                            "_begin_dialogs_processed", []
                        )
                        if begin_dialogs:
                            contexts.extend(begin_dialogs)
                        if DEBUG_MODE:
                            logger.info(
                                f"å·²è·å–äººæ ¼æç¤ºè¯ï¼ˆprovider_manageræ–¹å¼ï¼‰ï¼Œé•¿åº¦: {len(system_prompt)} å­—ç¬¦"
                            )
                    else:
                        # fallback: ä½¿ç”¨persona_manager
                        default_persona = (
                            await context.persona_manager.get_default_persona_v3(
                                event.unified_msg_origin
                            )
                        )
                        system_prompt = default_persona.get("prompt", "")
                        if DEBUG_MODE:
                            logger.info(
                                f"å·²è·å–äººæ ¼æç¤ºè¯ï¼ˆpersona_manageræ–¹å¼ï¼‰ï¼Œé•¿åº¦: {len(system_prompt)} å­—ç¬¦"
                            )
                else:
                    # fallback: ä½¿ç”¨persona_manager
                    default_persona = (
                        await context.persona_manager.get_default_persona_v3(
                            event.unified_msg_origin
                        )
                    )
                    system_prompt = default_persona.get("prompt", "")
                    if DEBUG_MODE:
                        logger.info(
                            f"å·²è·å–äººæ ¼æç¤ºè¯ï¼ˆpersona_manageræ–¹å¼ï¼‰ï¼Œé•¿åº¦: {len(system_prompt)} å­—ç¬¦"
                        )
            except Exception as e:
                logger.warning(f"è·å–äººæ ¼è®¾å®šå¤±è´¥: {e}ï¼Œä½¿ç”¨ç©ºäººæ ¼")

            # ä½¿ç”¨event.request_llmæ¥ç”Ÿæˆå›å¤
            # ç›´æ¥ä¼ å…¥system_promptï¼Œä¸ä½¿ç”¨conversation
            # å¦‚æœæœ‰å›¾ç‰‡URLï¼Œä¼ é€’ç»™å¤šæ¨¡æ€AI
            if image_urls:
                if DEBUG_MODE:
                    logger.info(f"ğŸŸ¢ [å¤šæ¨¡æ€AI] ä¼ é€’ {len(image_urls)} å¼ å›¾ç‰‡ç»™LLM")
                    if logger.level <= 10:  # DEBUGçº§åˆ«
                        for i, url in enumerate(image_urls):
                            logger.info(f"  å›¾ç‰‡ {i}: {url}")

            return event.request_llm(
                prompt=full_prompt,
                func_tool_manager=func_tools_mgr,
                contexts=contexts,  # åŒ…å«begin_dialogs
                system_prompt=system_prompt,  # ç›´æ¥ä½¿ç”¨äººæ ¼çš„prompt
                image_urls=image_urls,  # ä¼ é€’å›¾ç‰‡URLåˆ—è¡¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            )

        except Exception as e:
            logger.error(f"ç”ŸæˆAIå›å¤æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            # è¿”å›é”™è¯¯æ¶ˆæ¯
            return event.plain_result(f"ç”Ÿæˆå›å¤æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}")

    @staticmethod
    def check_if_already_replied(event: AstrMessageEvent) -> bool:
        """
        æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²è¢«å…¶ä»–æ’ä»¶å¤„ç†

        ç”¨äº@æ¶ˆæ¯å…¼å®¹ï¼Œé¿å…é‡å¤å›å¤

        Args:
            event: æ¶ˆæ¯äº‹ä»¶

        Returns:
            True=å·²æœ‰å›å¤ï¼ŒFalse=å°šæœªå›å¤
        """
        try:
            # æ£€æŸ¥eventçš„resultå­—æ®µ
            # å¦‚æœå·²ç»æœ‰result,è¯´æ˜å·²ç»è¢«å¤„ç†äº†
            result = event.get_result()

            if result is None:
                return False

            # AstrBot ä¼šå°†å­—ç¬¦ä¸²ç»“æœè½¬æ¢ä¸º MessageEventResult
            if isinstance(result, MessageEventResult):
                has_stream = bool(getattr(result, "async_stream", None))
                has_chain = bool(getattr(result, "chain", []) or [])
                is_llm = bool(
                    getattr(result, "is_llm_result", None) and result.is_llm_result()
                )
                is_stopped = bool(
                    getattr(result, "result_type", None) == EventResultType.STOP
                )
                is_stream_state = bool(
                    getattr(result, "result_content_type", None)
                    in {
                        ResultContentType.STREAMING_RESULT,
                        ResultContentType.STREAMING_FINISH,
                    }
                )

                if has_stream or has_chain or is_llm or is_stopped or is_stream_state:
                    logger.info("æ£€æµ‹åˆ°è¯¥æ¶ˆæ¯å·²ç»è¢«å…¶ä»–æ’ä»¶å¤„ç†")
                    return True

                return False

            # æœªçŸ¥ç±»å‹çš„ç»“æœï¼Œä¿æŒå‘åå…¼å®¹ï¼šåªè¦éç©ºè§†ä¸ºå·²å¤„ç†
            if result:
                logger.info("æ£€æµ‹åˆ°è¯¥æ¶ˆæ¯å·²ç»è¢«å…¶ä»–æ’ä»¶å¤„ç†")
                return True

            return False

        except Exception as e:
            logger.error(f"æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å›å¤æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            # å‘ç”Ÿé”™è¯¯æ—¶,ä¸ºå®‰å…¨èµ·è§,è¿”å›Trueé¿å…é‡å¤å›å¤
            return True
