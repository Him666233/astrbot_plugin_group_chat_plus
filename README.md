# 群聊增强插件 (Group Chat Plus)

<div align="center">

[![Version](https://img.shields.io/badge/version-v1.0.0-blue.svg)](https://github.com/Him666233/astrbot_plugin_group_chat_plus)
[![AstrBot](https://img.shields.io/badge/AstrBot-%E2%89%A5v4.0.0-green.svg)](https://github.com/AstrBotDevs/AstrBot)
[![License](https://img.shields.io/badge/license-AGPL--3.0-orange.svg)](LICENSE)

一个以 **AI读空气** 为核心的群聊增强插件，让你的Bot更懂氛围、更自然地参与群聊互动

[功能特性](#-功能特性) • [安装方法](#-安装方法) • [配置指南](#-配置指南) • [工作原理](#-工作原理) • [常见问题](#-常见问题)

</div>

---

## 本插件的开发从以下开源项目中获得了灵感，特此感谢。我们并未直接使用其代码，但借鉴了其优秀的功能设计：

- 项目名称：astrbot_plugin_SpectreCore
- 项目仓库地址：https://github.com/23q3/astrbot_plugin_SpectreCore
- 项目作者：23q3

## 本插件开发的记忆系统借用strbot_plugin_play_sy(又名：ai_memory)，优秀的记忆插件搭配让AI的判断和回复更加智能，特此感谢：

- 项目名称：strbot_plugin_play_sy
- 项目仓库地址：https://github.com/kjqwer/strbot_plugin_play_sy
- 项目作者：kjqwdw

## 📖 插件简介

在群聊场景中，Bot需要像真人一样"读懂气氛"——既不能过于活跃导致刷屏，也不能完全沉默失去存在感。本插件通过**AI智能判断**、**动态概率调整**和**智能缓存机制**，让Bot实现真正的"读空气"能力。

### 🎯 核心优势

- **🧠 AI读空气** - 通过专门的AI判断是否应该回复当前消息
- **📈 动态概率** - 回复后自动提升触发概率，促进连续对话
- **💾 智能缓存** - 保存未回复消息的上下文，避免记忆断裂
- **🔄 官方同步** - 自动同步到AstrBot官方对话系统
- **🤝 最大兼容** - 仅监听消息不拦截，不影响其他插件

---

## ✨ 功能特性

### 核心功能

| 功能 | 说明 | 优势 |
|------|------|------|
| **AI读空气判断** | 两层过滤机制：概率筛选 + AI智能判断 | 精准控制回复时机，避免过度活跃 |
| **动态概率调整** | AI回复后自动提升触发概率 | 促进连续对话，营造自然互动 |
| **智能缓存系统** | 保存"通过筛选但未回复"的消息 | 下次回复时保持完整上下文 |
| **官方历史同步** | 自动保存到AstrBot对话系统 | 与官方功能完美集成 |
| **@消息优先** | @消息跳过所有判断直接回复 | 确保重要消息不遗漏 |

### 增强功能

<details>
<summary><b>📝 消息元数据增强</b></summary>

- **时间戳信息**: 为消息添加发送时间（年月日时分秒）
- **发送者信息**: 添加发送者ID和昵称
- 帮助AI更好理解对话场景和时间关系
</details>

<details>
<summary><b>🖼️ 图片处理支持</b></summary>

- **三种处理模式**:
  - 模式1: 禁用图片（过滤图片消息）
  - 模式2: 多模态AI直接处理图片
  - 模式3: AI图片转文字 → 文本描述
- **应用范围可选**: 全部消息 / 仅@消息
- **图片描述缓存**: 自动保存图片描述到上下文
</details>

<details>
<summary><b>🔗 上下文管理</b></summary>

- 灵活配置历史消息数量（0 / 正数 / -1不限制）
- 自动合并缓存消息，避免上下文断裂
- 智能去重，防止重复保存
- 自动清理过期缓存（30分钟）
</details>

<details>
<summary><b>🧩 高级集成</b></summary>

- **记忆植入**: 强制调用 `strbot_plugin_play_sy` 长期记忆插件
- **工具提醒**: 自动提示AI当前可用的所有工具
- **触发关键词**: 配置特定关键词跳过判断直接回复
- **黑名单关键词**: 过滤不想处理的消息
</details>

---

## 🚀 安装方法

### 直接下载

1. 下载整个 `astrbot_plugin_group_chat_plus` 文件夹
2. 将文件夹放入AstrBot的 `/data/plugins` 目录下
3. 重启AstrBot
4. 在AstrBot插件管理面板中找到插件并配置


### 依赖要求

- **必需**: AstrBot >= v4.0.0
- **可选**: `strbot_plugin_play_sy` （记忆植入功能需要）

---

## ⚙️ 配置指南

### 快速开始配置

如果你是第一次使用，推荐使用以下配置快速开始：

```json
{
  "initial_probability": 0.3,
  "after_reply_probability": 0.8,
  "probability_duration": 120,
  "decision_ai_timeout": 30,
  "max_context_messages": -1,
  "include_timestamp": true,
  "include_sender_info": true,
  "enabled_groups": []
}
```

### 详细配置说明

#### 📊 概率控制（核心配置）

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `initial_probability` | float | 0.3 | **初始读空气概率**<br>AI初始判断是否回复消息的概率，范围0.0-1.0<br>示例: 0.1=10%概率触发 |
| `after_reply_probability` | float | 0.8 | **回复后概率**<br>AI回复后临时提升的概率，促进连续对话<br>建议: 设置为0.7-0.9 |
| `probability_duration` | int | 120 | **概率提升持续时间（秒）**<br>提升概率的持续时间，超时后恢复初始概率<br>建议: 120-600秒 |

> 💡 **概率调整建议**:
> - 轻度活跃: `0.05` → `0.6` (持续180秒)
> - 中度活跃: `0.1` → `0.8` (持续300秒)
> - 高度活跃: `0.3` → `0.95` (持续600秒)

#### 🤖 AI提供商配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `decision_ai_provider_id` | string | "" | **读空气AI提供商ID**<br>用于判断是否回复的AI，留空使用默认<br>建议: 使用轻量快速的模型 |
| `decision_ai_extra_prompt` | string | "" | **读空气AI额外提示词**<br>自定义判断逻辑，留空使用默认积极模式 |
| `decision_ai_timeout` | int | 30 | **读空气AI超时时间（秒）**<br>AI判断的超时时间，超时将默认不回复<br>• 快速AI: 20-30秒<br>• 较慢AI: 40-60秒 |
| `reply_ai_extra_prompt` | string | "" | **回复AI额外提示词**<br>自定义回复风格 |

#### 📝 消息元数据

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `include_timestamp` | bool | true | **包含时间戳**<br>为消息添加发送时间（格式：2025年01月27日 15:30:45） |
| `include_sender_info` | bool | true | **包含发送者信息**<br>添加发送者ID和昵称（格式：[发送者: 张三(ID: 123456)]） |

#### 🗂️ 上下文配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `max_context_messages` | int | -1 | **最大上下文消息数**<br>• `-1`: 不限制（推荐）<br>• `正数`: 限制数量<br>• `0`: 不获取历史 |

#### 🖼️ 图片处理

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enable_image_processing` | bool | false | **允许处理图片**<br>开启后可处理包含图片的消息 |
| `image_to_text_scope` | string | "all" | **图片转文字应用范围**<br>• `all`: 对所有消息适用<br>• `mention_only`: 仅@消息（推荐，节省API） |
| `image_to_text_provider_id` | string | "" | **图片转文字AI提供商ID**<br>留空则使用多模态AI直接处理图片 |
| `image_to_text_prompt` | string | "请详细描述这张图片的内容" | **图片转文字提示词** |
| `image_to_text_timeout` | int | 60 | **图片转文字超时时间（秒）**<br>AI调用超时时间，根据提供商速度调整<br>• 快速API: 30-60秒<br>• 本地模型: 90-120秒 |

> ⚠️ **图片处理注意**:
> - 留空 `image_to_text_provider_id` 需要确保默认AI支持多模态
> - 建议将 `image_to_text_scope` 设为 `mention_only` 避免频繁调用API
> - 图片描述会自动保存到缓存，下次回复时保持上下文
> - 如果出现图片转文字超时，请适当增加 `image_to_text_timeout` 值

#### 🧩 高级功能

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enable_memory_injection` | bool | false | **启用强制记忆植入**<br>强制调用 `strbot_plugin_play_sy` 插件获取长期记忆<br>⚠️ 需要先安装记忆插件 |
| `enable_tools_reminder` | bool | false | **启用工具提醒**<br>自动提示AI当前可用的所有工具 |

#### 🔑 关键词配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `trigger_keywords` | list | [] | **触发关键词列表**<br>包含这些关键词时跳过读空气判断，直接回复<br>示例: `["帮助", "查询", "天气"]` |
| `blacklist_keywords` | list | [] | **黑名单关键词列表**<br>包含这些关键词时直接忽略消息<br>示例: `["广告", "推广"]` |

#### 🎯 启用范围

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled_groups` | list | [] | **启用的群组列表**<br>• `[]`: 所有群聊启用（推荐测试）<br>• `["群号1", "群号2"]`: 仅指定群启用（推荐生产）<br>⚠️ 本插件仅支持群聊，不处理私聊 |

#### 🐛 调试配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enable_debug_log` | bool | false | **启用详细日志**<br>输出详细的调试信息，便于排查问题 |

---

## 🔧 工作原理

### 完整处理流程

```
📨 收到群消息
    ↓
【步骤1】基础检查
    ├─ 检查群组是否启用
    ├─ 检查是否bot自己的消息
    └─ ✅ 通过 → 继续
    ↓
【步骤2】黑名单关键词检查
    ├─ 包含黑名单关键词？
    └─ ❌ 是 → 丢弃消息
    └─ ✅ 否 → 继续
    ↓
【步骤3】@消息检测
    ├─ 是否@机器人？
    └─ 记录状态 → 继续
    ↓
【步骤4】触发关键词检查
    ├─ 包含触发关键词？
    └─ 记录状态 → 继续
    ↓
【步骤5】读空气概率判断
    ├─ 是@消息或触发关键词？
    │   └─ ✅ 是 → 跳过概率判断
    └─ ❌ 否 → 概率判断
        ├─ 随机值 < 当前概率？
        └─ ❌ 否 → 丢弃消息
        └─ ✅ 是 → 继续
    ↓
【步骤6】添加消息元数据
    ├─ 添加时间戳（可选）
    ├─ 添加发送者信息（可选）
    └─ ✅ 元数据处理完成
    ↓
【步骤6.5】处理图片（在缓存之前）
    ├─ mention_only模式检查
    │   └─ 非@消息的图片 → 丢弃（不缓存）
    ├─ 未启用图片处理？
    │   └─ 纯图片消息 → 丢弃
    │   └─ 图文消息 → 移除图片
    ├─ 配置了图片转文字AI？
    │   └─ ✅ 是 → 调用AI转为文字描述
    │       ├─ 使用配置的超时时间（image_to_text_timeout）
    │       ├─ 转换成功 → 保存图片描述（后续缓存）
    │       └─ 超时或失败 → 降级处理（移除图片或丢弃）
    └─ 否 → 使用多模态AI直接处理
    ↓
【步骤7】缓存纯净用户消息（图片处理通过后）
    ├─ 只缓存原始消息（不含元数据）
    ├─ 如有图片描述，一并缓存
    ├─ 添加到pending_messages_cache
    ├─ 清理超过30分钟的旧消息
    └─ 限制缓存最多10条
    ↓
【步骤8】提取历史上下文
    ├─ 从官方存储读取历史消息
    ├─ 合并缓存中的消息（去重）
    ├─ 应用max_context_messages限制
    └─ 格式化为AI可读文本
    ↓
【步骤9】决策AI判断
    ├─ 是@消息或触发关键词？
    │   └─ ✅ 是 → 跳过决策AI
    └─ ❌ 否 → 调用决策AI
        ├─ 构建完整提示词（含人格+上下文）
        ├─ 调用AI判断（使用配置的超时时间 decision_ai_timeout）
        └─ 解析yes/no结果
            ├─ 超时 → 默认不回复，将消息保存到缓存中后退出
            ├─ ❌ no → 保存用户消息到缓存中，退出
            └─ ✅ yes → 继续
    ↓
【步骤10】标记会话
    └─ 添加到processing_sessions（用于after_message_sent识别）
    ↓
【步骤11】注入记忆（可选）
    ├─ 启用记忆植入？
    └─ ✅ 是 → 调用记忆插件获取记忆
        └─ 注入到消息中
    ↓
【步骤12】注入工具信息（可选）
    ├─ 启用工具提醒？
    └─ ✅ 是 → 获取可用工具列表
        └─ 注入到消息中
    ↓
【步骤13】调用AI生成回复
    ├─ 构建完整消息（上下文+记忆+工具+额外提示词）
    ├─ 调用默认AI生成回复
    └─ ✅ 生成回复
    ↓
【步骤14】保存用户消息
    └─ 保存到自定义历史存储
    ↓
【步骤15】发送回复
    └─ yield 返回回复内容
    ↓
【步骤16】调整读空气概率
    └─ 提升概率至after_reply_probability
        └─ 持续probability_duration秒
    ↓
【after_message_sent钩子】
    ├─ 检查是否本插件处理的会话
    ├─ 提取AI回复文本
    ├─ 获取缓存的用户消息（含图片描述）
    ├─ 合并缓存消息（去重）
    ├─ 保存到官方对话系统（conversation表）
    ├─ 验证保存成功
    └─ 清空pending_messages_cache
    ↓
✅ 完成
```

### 智能缓存机制

插件采用独特的**缓存+转正**机制，避免上下文断裂：

```
场景1: AI决定回复
    用户消息A → 缓存 → AI回复 → 缓存转正 → 保存到官方系统 → 清空缓存

场景2: AI决定不回复
    用户消息A → 缓存 → AI不回复 → 保存到自定义存储（不清空缓存）
    用户消息B → 缓存 → AI回复 → 缓存转正（含A+B） → 保存到官方系统 → 清空缓存

结果: 官方对话系统中包含完整的上下文（A+B+回复），没有丢失A！
```

#### 缓存特性：

- **自动清理**: 超过30分钟的消息自动移除
- **容量限制**: 最多保留10条消息
- **图片描述保存**: 图片转文字的描述也保存在缓存中
- **智能去重**: 转正时自动过滤重复消息
- **线程安全**: 多会话并发处理安全

### @消息优先机制

```
@消息处理流程:
    检测到@机器人
        ↓
    跳过概率判断（必定处理）
        ↓
    跳过决策AI判断（必定回复）
        ↓
    检查其他插件是否已回复
        ├─ 已回复 → 退出（避免重复）
        └─ 未回复 → 继续处理
```

---

## 🎨 使用场景与配置推荐

### 场景1: 话痨型Bot（高度活跃）

**适用**: 娱乐群、游戏群、小规模测试群

```json
{
  "initial_probability": 0.4,
  "after_reply_probability": 0.95,
  "probability_duration": 600,
  "max_context_messages": 30,
  "decision_ai_extra_prompt": "你是一个活泼开朗、喜欢聊天的角色。在大部分情况下都应该积极参与讨论。"
}
```

### 场景2: 平衡型Bot（中度活跃）

**适用**: 技术群、学习群、日常交流群

```json
{
  "initial_probability": 0.1,
  "after_reply_probability": 0.8,
  "probability_duration": 300,
  "max_context_messages": 20,
  "decision_ai_extra_prompt": "你是一个友好的助手，在有价值的讨论中参与，避免打断私人对话。"
}
```

### 场景3: 沉稳型Bot（轻度活跃）

**适用**: 工作群、正式群、大规模群

```json
{
  "initial_probability": 0.05,
  "after_reply_probability": 0.6,
  "probability_duration": 180,
  "max_context_messages": 10,
  "decision_ai_extra_prompt": "你是一个专业、谨慎的助手，只在明确需要你帮助或回答问题时才回复。"
}
```

### 场景4: 图片处理Bot

**适用**: 需要理解图片内容的群

```json
{
  "enable_image_processing": true,
  "image_to_text_scope": "mention_only",
  "image_to_text_provider_id": "your_vision_ai_id",
  "image_to_text_prompt": "请详细描述这张图片的内容，包括主要物体、场景、文字等信息",
  "initial_probability": 0.2
}
```

### 场景5: 关键词触发Bot

**适用**: 客服群、工具群

```json
{
  "trigger_keywords": ["帮助", "help", "查询", "查看", "指令"],
  "blacklist_keywords": ["广告", "推广", "加群"],
  "initial_probability": 0.05,
  "enabled_groups": ["123456789", "987654321"]
}
```

---

## 💡 提示词定制

### 决策AI提示词示例

#### 积极参与型
```
你是一个热情友好的群聊成员，喜欢参与讨论。

应该回复的情况：
- 话题与你感兴趣的领域相关（动漫、游戏、科技、编程等）
- 有人提问或寻求帮助
- 讨论内容与你之前的发言相关
- 可以提供有价值的信息或观点
- 群聊气氛活跃，适合互动

不应该回复的情况：
- 明显是他人的私密对话
- 只是简单的寒暄（早、晚安、吃饭了吗等）
- 纯表情或无意义内容
- 重复或已解决的问题

不确定时倾向于回复，保持群聊活跃。
```

#### 专业助手型
```
你是一个专业的技术助手，谨慎判断是否需要参与。

应该回复的情况：
- 直接向你提问
- 讨论技术问题且你有专业见解
- 需要纠正明显的错误信息
- 话题与你的专业领域高度相关

不应该回复的情况：
- 闲聊或娱乐话题
- 他人已给出正确答案
- 私人对话
- 超出你的知识范围

默认保持专业和谨慎，只在必要时发言。
```

#### 角色扮演型
```
你正在扮演一个特定角色：[角色名]
性格特点：[性格描述]
说话风格：[风格描述]

根据你的角色特点判断是否参与对话：
- 符合角色人设的话题积极参与
- 不符合人设的话题保持沉默
- 保持角色的一致性和真实感

示例：
如果你是"技术宅"，对编程、游戏话题感兴趣
如果你是"文学少女"，对书籍、诗词话题感兴趣
```

### 回复AI提示词示例

#### 自然对话型
```
回复要求：
- 保持自然、轻松的对话风格
- 可以适当使用表情和网络用语
- 避免过于正式或生硬
- 回复长度适中，不要过长或过短
- 如果不确定，可以提出问题引导对话
```

#### 简洁专业型
```
回复要求：
- 直接回答问题，简洁明了
- 使用专业术语但确保易懂
- 必要时提供代码示例或链接
- 避免闲聊和无关内容
```

---

## ❓ 常见问题

<details>
<summary><b>Q1: 为什么Bot回复太频繁/太少？</b></summary>

**A**: 这是概率配置问题，请调整：

- **太频繁**: 降低 `initial_probability` 和 `after_reply_probability`
- **太少**: 提高这两个概率值
- 建议从 `0.1` 开始测试，观察效果后逐步调整
- 也可以通过 `decision_ai_extra_prompt` 调整决策AI的判断逻辑
</details>

<details>
<summary><b>Q2: 为什么@消息没有回复？</b></summary>

**A**: 可能的原因：

1. 其他插件已经处理了这条消息（本插件会检测并避免重复回复）
2. 群组未在 `enabled_groups` 列表中
3. 检查日志看是否有错误信息
4. 确认 `enable_debug_log` 开启后查看详细流程
</details>

<details>
<summary><b>Q3: 图片转文字不工作？</b></summary>

**A**: 检查以下配置：

1. `enable_image_processing` 是否为 `true`
2. `image_to_text_provider_id` 是否填写（留空则需多模态AI）
3. 如果留空，确认默认AI支持视觉能力
4. 检查 `image_to_text_scope` 设置（`all` 或 `mention_only`）
5. 查看日志确认是否有API调用错误
</details>

<details>
<summary><b>Q4: 缓存消息会丢失吗？</b></summary>

**A**: 不会丢失，缓存机制确保：

1. 通过筛选但AI未回复的消息会保存到自定义历史
2. 下次AI回复时会一起转正到官方系统
3. 即使30分钟后清理，也已经保存在自定义存储中
4. 缓存只是临时中转，最终都会持久化
</details>

<details>
<summary><b>Q5: 记忆植入功能如何使用？</b></summary>

**A**: 使用步骤：

1. 先安装 `strbot_plugin_play_sy` (AI记忆插件)
2. 配置该插件并确保正常工作
3. 在本插件中设置 `enable_memory_injection` 为 `true`
4. 本插件会自动调用记忆插件获取相关记忆
5. 记忆内容会注入到AI的输入中
</details>

<details>
<summary><b>Q6: 可以在私聊中使用吗？</b></summary>

**A**: **不可以**。本插件设计为群聊专用：

- 私聊消息会直接跳过处理
- 这是因为私聊场景不需要"读空气"
- 私聊建议使用AstrBot官方的对话功能
</details>

<details>
<summary><b>Q7: 如何调试插件问题？</b></summary>

**A**: 调试步骤：

1. 设置 `enable_debug_log` 为 `true`
2. 重启插件或重载插件
3. 发送测试消息
4. 查看日志输出的详细流程（15个步骤）
5. 定位是哪个步骤出现问题
6. 根据日志信息调整配置或排查错误
</details>

<details>
<summary><b>Q8: 会影响其他插件吗？</b></summary>

**A**: **不会**。本插件设计为最大兼容：

- 使用 `@event_message_type` 监听而非拦截
- 不修改event对象
- 不阻断消息传递
- @消息会检测其他插件是否已回复
- 可以与任何其他插件共存
</details>

<details>
<summary><b>Q9: 如何设置仅在特定群启用？</b></summary>

**A**: 配置 `enabled_groups`：

```json
{
  "enabled_groups": ["123456789", "987654321"]
}
```

- 留空 `[]`: 所有群聊启用
- 填写群号: 仅指定群启用
- 群号是字符串格式
- 可以随时添加或移除群号
</details>

<details>
<summary><b>Q10: 决策AI超时怎么办？</b></summary>

**A**: 插件有超时保护机制：

- 超时后默认判定为"不回复"
- 不会卡住或影响其他消息
- 如果经常超时，可以：
  - **调整超时时间**: 增加 `decision_ai_timeout` 配置值（默认30秒）
  - **更换AI模型**: 使用更快的AI提供商
  - **减少上下文**: 降低 `max_context_messages` 减少输入长度
  - **检查网络**: 确认AI服务的响应速度正常
</details>

---

## 🔍 技术细节

### 模块架构

```
astrbot_plugin_group_chat_plus/
├── main.py                      # 主插件类，事件监听与流程控制
├── metadata.yaml                # 插件元数据
├── _conf_schema.json            # 配置schema定义
├── requirements.txt             # 依赖声明（目前无额外依赖）
└── utils/                       # 工具模块
    ├── __init__.py              # 模块导出
    ├── probability_manager.py   # 概率管理器（动态概率调整）
    ├── message_processor.py     # 消息处理器（元数据添加）
    ├── image_handler.py         # 图片处理器（转文字/多模态）
    ├── context_manager.py       # 上下文管理器（历史消息/缓存）
    ├── decision_ai.py           # 决策AI（读空气判断）
    ├── reply_handler.py         # 回复处理器（生成回复）
    ├── memory_injector.py       # 记忆注入器（集成记忆插件）
    ├── tools_reminder.py        # 工具提醒器（提示可用工具）
    └── keyword_checker.py       # 关键词检查器（触发词/黑名单）
```

### 数据流

```
用户消息 → 概率筛选 → AI决策 → 上下文提取 → 记忆注入 → 工具提醒 → AI回复 → 历史保存
            ↓                      ↓                                        ↓
         缓存系统 ←────────────── 智能去重 ←──────────────────────────── 缓存转正
```

### 存储结构

#### 自定义历史存储
```
data/
└── chat_history/
    └── {platform_name}/
        ├── group/
        │   └── {group_id}.json       # 群聊历史
        └── private/
            └── {user_id}.json        # 私聊历史（预留）
```

#### 缓存结构
```python
pending_messages_cache = {
    "chat_id": [
        {
            "role": "user",
            "content": "带元数据的消息",
            "timestamp": 1706347200.0,
            "image_description": "图片描述（可选）"
        },
        # ... 更多消息
    ]
}
```

---

## 🛠️ 高级用法

### 自定义决策逻辑

通过 `decision_ai_extra_prompt` 可以完全自定义判断逻辑：

```json
{
  "decision_ai_extra_prompt": "判断规则：\n1. 如果消息包含'python'或'代码'，一定回复\n2. 如果是纯表情，不回复\n3. 如果是提问（含'吗'、'?'、'？'），倾向回复\n4. 其他情况根据上下文判断"
}
```

### 多群组差异化配置

虽然插件本身不支持多配置，但可以通过以下方式实现：

1. **方案1**: 部署多个插件实例，每个配置不同的 `enabled_groups`
2. **方案2**: 使用 `decision_ai_extra_prompt` 根据群组特点调整
3. **方案3**: 修改插件代码，支持多配置（需要二次开发）

### 与其他插件联动

#### 与命令插件联动
```json
{
  "blacklist_keywords": ["/", "!"],
  "comment": "过滤命令前缀，避免与命令插件冲突"
}
```

#### 与定时任务联动
```json
{
  "trigger_keywords": ["提醒", "定时"],
  "comment": "关键词触发后可调用定时任务插件"
}
```

---

## 📊 性能与优化

### 性能指标

- **消息处理延迟**: < 2秒（不含AI调用时间）
- **缓存内存占用**: 约10KB/群（10条消息）
- **并发支持**: 多群组并发处理，线程安全
- **历史文件大小**: 约1MB/群/200条消息

### 优化建议

1. **控制上下文数量**: `max_context_messages` 不要设置过大
2. **合理设置概率**: 避免过高的概率导致频繁调用AI
3. **图片处理**: 使用 `mention_only` 减少不必要的API调用
4. **缓存清理**: 默认30分钟清理，无需手动维护
5. **日志管理**: 生产环境关闭 `enable_debug_log`

---

## 📝 更新日志

### v1.0.0 (2025-10-28)

**🎉 初始版本发布**

**核心功能**:
- ✅ AI读空气判断（两层过滤机制）
- ✅ 动态概率调整（回复后自动提升）
- ✅ 智能缓存系统（避免上下文断裂）
- ✅ 官方历史同步（自动保存到conversation表）
- ✅ @消息优先处理（跳过判断直接回复）

**增强功能**:
- ✅ 消息元数据（时间戳+发送者信息）
- ✅ 图片处理（转文字/多模态/应用范围可选）
- ✅ 上下文管理（灵活配置历史数量）
- ✅ 记忆植入（集成ai_memory插件）
- ✅ 工具提醒（自动提示可用工具）
- ✅ 触发关键词（特定词直接回复）
- ✅ 黑名单关键词（过滤不想处理的消息）

**技术特性**:
- ✅ 最大兼容性设计（仅监听不拦截）
- ✅ 完善的错误处理（30秒超时保护）
- ✅ 详细的调试日志（15步骤可追踪）
- ✅ 线程安全（并发处理支持）
- ✅ 智能去重（缓存转正时自动去重）

---

## 🤝 贡献与反馈

### 报告问题

如果你遇到Bug或有功能建议，请：

1. 开启 `enable_debug_log` 获取详细日志
2. 在GitHub仓库提交Issue
3. 附上完整的错误信息和配置
4. 描述复现步骤

### 功能建议

欢迎提出新功能建议：

- 描述使用场景
- 说明预期效果
- 附上参考示例（如有）

### 参与开发

欢迎Pull Request：

1. Fork本仓库
2. 创建feature分支
3. 提交代码并测试
4. 提交PR并描述改动

---

## 📜 许可证

本项目采用 **AGPL-3.0 License** 开源协议。

你可以自由地：
- ✅ 使用本插件
- ✅ 修改源码
- ✅ 分发和再分发
- ✅ 用于商业用途

但必须遵守：
- 📝 保留原作者信息
- 📝 包含许可证副本
- 📝 以相同许可证（AGPL-3.0）分发修改版本
- 📝 说明你做了哪些修改
- 📝 如果通过网络提供服务，必须公开完整源代码

> ⚠️ **AGPL-3.0 重要提示**：如果你修改了本插件并在服务器上运行（即使不分发），只要用户通过网络与之交互，你就必须向用户提供修改后的完整源代码。这是 AGPL-3.0 与 GPL 的主要区别。

---

## 👤 作者

**Him666233**

- GitHub: [@Him666233](https://github.com/Him666233)
- 仓库地址: [astrbot_plugin_group_chat_plus](https://github.com/Him666233/astrbot_plugin_group_chat_plus)

---

## 🙏 致谢

感谢以下项目和开发者：

- [AstrBot](https://github.com/AstrBotDevs/AstrBot) - 优秀的Bot框架
- [astrbot_plugin_SpectreCore](https://github.com/23q3/astrbot_plugin_SpectreCore) - 提供了很多实现参考
- [strbot_plugin_play_sy](https://github.com/kjqwer/strbot_plugin_play_sy) - 记忆系统集成

---

## ⭐ Star History

如果这个插件对你有帮助，请给个Star⭐支持一下！

---

<div align="center">

**🎉 享受更自然的群聊互动体验！**

Made with ❤️ by Him666233

</div>
